name: build

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "强制执行"
        required: false
        default: "true"

concurrency:
  group: build-test
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      # 1. Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 安装 SVN
      - name: Install Subversion
        run: |
          sudo apt-get update
          sudo apt-get install -y subversion
          svn --version

      # 3. 缓存
      - name: Cache SVN working copy
        id: cache-svn
        uses: actions/cache@v4
        with:
          path: src
          key: svn-wc-${{ runner.os }}

      # 4. 获取 SVN 最新 revision
      - name: Get SVN latest revision
        id: svn
        env:
          SVN_URL: ${{ secrets.SVN_URL }}
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
        run: |
          # 使用 grep 提取版本号
          REV=$(svn info $SVN_URL --username $SVN_USERNAME --password $SVN_PASSWORD --non-interactive --trust-server-cert-failures=unknown-ca,cn-mismatch,expired,not-yet-valid | grep "^Revision:" | awk '{print $2}')
          if [ -z "$REV" ]; then echo "Failed to get SVN revision"; exit 1; fi
          echo "rev=$REV" >> $GITHUB_OUTPUT
          echo "SVN revision: $REV"

      # 5. 读取上一次 revision
      - name: Load last revision
        id: last
        run: |
          if [ -f ".ci/last_revision.txt" ]; then
            LAST=$(cat .ci/last_revision.txt)
          else
            LAST=0
          fi
          echo "last=$LAST" >> $GITHUB_OUTPUT
          echo "Last recorded revision: $LAST"

      # 6. 对比 revision / force
      - name: Compare revision
        id: diff
        run: |
          FORCE="${{ github.event.inputs.force }}"
          REV="${{ steps.svn.outputs.rev }}"
          LAST="${{ steps.last.outputs.last }}"

          if [ "$FORCE" = "true" ] || [ "$REV" -gt "$LAST" ]; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "Update needed"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "No update needed"
          fi

      # 7. 拉取 / 更新 SVN
      - name: Checkout or Update SVN
        if: steps.diff.outputs.updated == 'true'
        env:
          SVN_URL: ${{ secrets.SVN_URL }}
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
        run: |
          if [ -d "src/.svn" ]; then
            echo "SVN working copy found, updating..."
            svn update src --username $SVN_USERNAME --password $SVN_PASSWORD --non-interactive --trust-server-cert-failures=unknown-ca,cn-mismatch,expired,not-yet-valid --quiet
          else
            echo "No SVN working copy, checkout..."
            svn checkout $SVN_URL src --username $SVN_USERNAME --password $SVN_PASSWORD --non-interactive --trust-server-cert-failures=unknown-ca,cn-mismatch,expired,not-yet-valid --quiet
          fi

      # 8. Godot 下载
      - name: Godot download
        run: |
          wget ${{ secrets.GODOT_DOWNLOAD_URL }} -O godot.zip
          unzip godot.zip
          # 查找解压后的二进制文件并重命名
          FILENAME=$(ls | grep "Godot_v.*_linux" | head -n 1)
          mv "$FILENAME" godot
          chmod +x godot

      # 9. 导入项目
      - name: Import project
        run: |
          ./godot --headless --quiet --import --path ./src/RedMemoryProject

      # 10. 运行测试
      - name: Run unit tests
        run: |
          # 运行测试并将日志输出到文件
          ./godot --headless --path ./src/RedMemoryProject -s res://addons/gut/gut_cmdln.gd -gdir=res://test -gexit -ginclude_subdirs --log-file ~/log.txt

      # 11. 发送邮件通知
      - name: Build email body
        if: always()
        run: |
          SUMMARY_FILE=/home/runner/summary.txt
          LOG_FILE=/home/runner/log.txt
          MAIL_FILE=/home/runner/mail_body.txt
      
          # 1. 提取 Summary（如果 log 存在）
          if [ -f "$LOG_FILE" ]; then
            sed -n '/^Summary Begin$/,/^Summary End$/p' "$LOG_FILE" \
              | sed '1d;$d' > "$SUMMARY_FILE"
      
            # 如果 Summary 区块不存在
            if [ ! -s "$SUMMARY_FILE" ]; then
              echo "Summary section not found in log." > "$SUMMARY_FILE"
            fi
          else
            echo "log.txt not found." > "$SUMMARY_FILE"
          fi
      
          # 2. 生成邮件正文
          {
            echo "Automated test finished."
            echo ""
            echo "Branch   : $GITHUB_REF_NAME"
            echo "Run ID   : $GITHUB_RUN_ID"
            echo "CI Run   : $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            echo ""
            cat "$SUMMARY_FILE"
          } > "$MAIL_FILE"
          
      - name: Send report email
        if: always()
        uses: hemupadhyay26/action-email-notification@v1.1
        with:
          type: 'password'
          server_address: ${{ secrets.SMTP_URL }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: ${{ github.repository }} CI Report
          to: ${{ secrets.SMTP_TO }}
          from: CI Bot <${{ secrets.SMTP_USER }}>
          body: file:///home/runner/mail_body.txt
          attachments: /home/runner/log.txt
          
      # 12. 安装导出模板
      - name: Install Godot export templates
        env:
          GODOT_TEMPLATES_URL: ${{ secrets.GODOT_TEMPLATES_URL }}
        run: |
          set -e
          TEMPLATE_ROOT="$HOME/.local/share/godot/export_templates"
          TPZ_FILE="templates.tpz"

          wget -O "$TPZ_FILE" "$GODOT_TEMPLATES_URL"

          # 从文件名提取版本号
          BASENAME=$(basename "$GODOT_TEMPLATES_URL")
          VERSION=$(echo "$BASENAME" | sed -E 's/Godot_v([0-9.]+)-([a-z0-9]+)_export_templates\.tpz/\1.\2/')

          echo "Detected Godot template version: $VERSION"

          mkdir -p "$TEMPLATE_ROOT"
          TMP_DIR=$(mktemp -d)

          unzip -q "$TPZ_FILE" -d "$TMP_DIR"

          # 重命名 templates 文件夹为版本号
          mkdir -p "$TEMPLATE_ROOT/$VERSION"
          mv "$TMP_DIR/templates/"* "$TEMPLATE_ROOT/$VERSION/"

          rm -rf "$TMP_DIR"

          echo "Godot export templates installed:"
          ls "$TEMPLATE_ROOT/$VERSION"

      # 13. 导出
      - name: Build
        run: |
          # 导出
          ./godot --headless --path ./src/RedMemoryProject --export-debug "Windows Desktop" ./export/RED-MEMORY.exe
          
      # 14. 保存新的 revision
      - name: Save new revision
        if: steps.diff.outputs.updated == 'true'
        run: |
          mkdir -p .ci
          echo "${{ steps.svn.outputs.rev }}" > .ci/last_revision.txt

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .ci/last_revision.txt
          if ! git diff --cached --quiet; then
            git commit -m "ci: update svn revision to ${{ steps.svn.outputs.rev }}"
            git push
          fi

      # 13. 清理
      - name: Clean up
        if: always()
        run: |
          rm -rf ./src/RedMemoryProject/.godot
